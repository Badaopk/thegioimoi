<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>C·ªù T·ª∑ Ph√∫ Online - H√†nh Tinh M∆° ∆Ø·ªõc</title>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        body { background: #2c3e50; color: white; margin: 0; font-family: 'Baloo 2', cursive; overflow: hidden; }
        
        /* 1. S·∫¢NH CH·ªú (LOBBY) */
        #lobby-screen {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://img.freepik.com/free-vector/monopoly-board-game-background_23-2148154477.jpg');
            background-size: cover;
        }
        .lobby-card {
            background: white; color: #333; padding: 30px; border-radius: 20px;
            width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .lobby-btn {
            width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 10px;
            font-size: 1.2rem; font-weight: bold; cursor: pointer; color: white; transition: 0.2s;
        }
        .btn-random { background: #e67e22; }
        .btn-create { background: #2ecc71; }
        .btn-join { background: #3498db; }
        .input-code { width: 90%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 1.1rem; text-align: center; }

        /* 2. B√ÄN C·ªú (GAME) */
        #game-screen { display: none; }
        .game-wrapper { display: flex; height: 100vh; width: 100vw; }
        .sidebar { width: 260px; background: #34495e; padding: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 10; }
        .player-card { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; border-left: 5px solid gray; }
        .player-card.active { background: rgba(46, 204, 113, 0.2); border-left-color: #2ecc71; }
        .log-box { flex-grow: 1; background: #2c3e50; padding: 10px; overflow-y: auto; border: 1px solid #7f8c8d; font-size: 0.8rem; margin-top: 10px; }
        .board-container { flex-grow: 1; display: flex; justify-content: center; align-items: center; background: #27ae60; position: relative; }
        .monopoly-board { display: grid; grid-template-columns: repeat(11, 60px); grid-template-rows: repeat(11, 60px); gap: 2px; background: #1e272e; padding: 5px; border: 5px solid #f1c40f; }
        .cell { background: #ecf0f1; color: #2c3e50; font-size: 0.6rem; display: flex; flex-direction: column; text-align: center; position: relative; border-radius: 2px; }
        .cell-header { height: 12px; width: 100%; background: gray; }
        .cell-name { font-weight: bold; padding: 2px; flex-grow: 1; display: flex; align-items: center; justify-content: center; }
        .token { width: 14px; height: 14px; border-radius: 50%; position: absolute; bottom: 3px; border: 1.5px solid white; transition: all 0.5s ease; }
        .center-control { grid-column: 2 / 11; grid-row: 2 / 11; background: #27ae60; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 10px; }
        .dice-display { font-size: 2.5rem; }
        .btn-action { padding: 10px 25px; font-size: 1.1rem; background: #e67e22; border: none; color: white; border-radius: 50px; cursor: pointer; box-shadow: 0 4px 0 #d35400; }
        .btn-action:disabled { background: #95a5a6; box-shadow: none; cursor: not-allowed; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: white; color: black; padding: 25px; border-radius: 15px; text-align: center; width: 280px; }
    </style>
</head>
<body>

    <div id="lobby-screen">
        <h1 style="color:white; font-size: 3.5rem; text-shadow: 4px 4px 0 #000;">VIETNAM TYCOON</h1>
        <div class="lobby-card">
            <button class="lobby-btn btn-random" onclick="findRandom()">üé≤ Gh√©p Ng·∫´u Nhi√™n</button>
            <hr>
            <button class="lobby-btn btn-create" onclick="createRoom()">üè† T·∫°o Ph√≤ng Ri√™ng</button>
            <div style="margin: 15px 0;">--- HO·∫∂C ---</div>
            <input type="text" id="room-input" class="input-code" placeholder="Nh·∫≠p m√£ ph√≤ng...">
            <button class="lobby-btn btn-join" onclick="joinRoom()">üö™ V√†o Ph√≤ng</button>
            <p id="lobby-status" style="font-weight:bold; color:#e67e22;"></p>
            <button class="back-button" onclick="window.location.href='index.html'">Quay L·∫°i</button>
        </div>
    </div>

    <div id="game-screen">
        <div class="game-wrapper">
            <div class="sidebar">
                <div style="text-align:center; color:#f1c40f; font-weight:bold;">M√É PH√íNG: <span id="display-room-id">---</span></div>
                <div id="player-list"></div>
                <div class="log-box" id="game-log"></div>
                <button class="btn-action" style="background:#e74c3c; width:100%;" onclick="location.reload()">Tho√°t Tr·∫≠n</button>
            </div>

            <div class="board-container">
                <div class="monopoly-board" id="board-grid">
                    <div class="center-control">
                        <div class="dice-display" id="dice-result">üé≤ üé≤</div>
                        <button class="btn-action" id="btn-roll" disabled>Gieo X√∫c X·∫Øc</button>
                        <button class="btn-action" id="btn-end-turn" style="background: #e74c3c; display:none;">K·∫øt Th√∫c L∆∞·ª£t</button>
                        <button class="btn-action" id="btn-start" style="background:#2ecc71; display:none;">B·∫Øt ƒê·∫ßu Game</button>
                        <div id="status-msg" style="font-weight:bold; color:white; font-size:1.1rem; text-align:center;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="buy-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">Mua ƒê·∫•t?</h2>
            <p id="modal-desc"></p>
            <div style="margin-top:20px; display:flex; gap:10px; justify-content:center;">
                <button class="btn-action" style="background:#2ecc71; padding: 5px 20px;" onclick="answerBuy(true)">MUA</button>
                <button class="btn-action" style="background:#e74c3c; padding: 5px 20px;" onclick="answerBuy(false)">B·ªé QUA</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="monopoly-data.js"></script>
    <script>
        const socket = io();
        let myCurrentRoom = null;

        // --- 1. LOGIC S·∫¢NH CH·ªú ---
        function findRandom() { socket.emit('findMonopolyMatch'); }
        function createRoom() { socket.emit('createMonopolyRoom'); }
        function joinRoom() {
            const code = document.getElementById('room-input').value.toUpperCase();
            if(code) socket.emit('joinMonopolyRoom', code);
            else alert("Vui l√≤ng nh·∫≠p m√£ ph√≤ng!");
        }

        socket.on('roomCreated', (id) => {
            myCurrentRoom = id;
            document.getElementById('display-room-id').textContent = id;
        });

        socket.on('statusMsg', (msg) => { document.getElementById('lobby-status').textContent = msg; });
        socket.on('errorMsg', (msg) => { alert(msg); });

        // --- 2. RENDER B√ÄN C·ªú (40 √î) ---
        function getGridStyle(i) {
            if (i <= 10) return `grid-row: 11; grid-column: ${11 - i};`;
            if (i <= 20) return `grid-column: 1; grid-row: ${11 - (i - 10)};`;
            if (i <= 30) return `grid-row: 1; grid-column: ${1 + (i - 20)};`;
            return `grid-column: 11; grid-row: ${1 + (i - 30)};`;
        }

        const boardEl = document.getElementById('board-grid');
        boardData.forEach(cell => {
            const div = document.createElement('div');
            div.className = 'cell'; div.style = getGridStyle(cell.id); div.id = `cell-${cell.id}`;
            let h = cell.color ? `<div class="cell-header" style="background:${cell.color}"></div>` : '';
            h += `<div class="cell-name">${cell.name}</div>`;
            if (cell.price) h += `<div style="font-weight:bold">$${cell.price}</div>`;
            div.innerHTML = h; boardEl.appendChild(div);
        });

        // --- 3. ƒê·ªíNG B·ªò GAME ---
        socket.on('monopolyUpdate', (data) => {
            myCurrentRoom = data.roomId || myCurrentRoom;
            document.getElementById('display-room-id').textContent = myCurrentRoom;
            document.getElementById('lobby-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';

            renderPlayers(data.players);
            updateLogs(data.logs);
            updateControls(data);
        });

        function renderPlayers(players) {
            const listEl = document.getElementById('player-list');
            listEl.innerHTML = '';
            document.querySelectorAll('.token').forEach(t => t.remove());

            players.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = `player-card ${p.id === socket.id ? 'active' : ''}`;
                div.style.borderLeftColor = p.color;
                div.innerHTML = `<strong>${p.username}</strong> ${p.id === socket.id ? '(B·∫°n)' : ''}<br>üí∞ $${p.money}`;
                listEl.appendChild(div);

                const cell = document.getElementById(`cell-${p.position}`);
                if (cell) {
                    const token = document.createElement('div');
                    token.className = 'token'; token.style.backgroundColor = p.color;
                    token.style.left = `${5 + (i * 8)}px`; cell.appendChild(token);
                }
            });
        }

        function updateControls(data) {
            const currentPlayer = data.players[data.turnIndex];
            const myTurn = (currentPlayer.id === socket.id);
            
            document.getElementById('btn-start').style.display = (data.gameState === 'waiting' && data.players[0].id === socket.id) ? 'block' : 'none';
            document.getElementById('btn-roll').disabled = !myTurn || data.gameState !== 'playing';
            
            if (data.gameState === 'waiting') {
                document.getElementById('status-msg').textContent = "Ch·ªù ch·ªß ph√≤ng b·∫Øt ƒë·∫ßu...";
            } else if (myTurn) {
                document.getElementById('status-msg').textContent = "ƒê·∫æN L∆Ø·ª¢T B·∫†N!";
            } else {
                document.getElementById('status-msg').textContent = `L∆∞·ª£t c·ªßa ${currentPlayer.username}`;
            }
        }

        function updateLogs(logs) {
            document.getElementById('game-log').innerHTML = logs.slice(-20).map(l => `<div>${l}</div>`).reverse().join('');
        }

        // --- 4. T∆Ø∆†NG T√ÅC ---
        document.getElementById('btn-start').onclick = () => socket.emit('startMonopoly', myCurrentRoom);
        document.getElementById('btn-roll').onclick = () => socket.emit('rollDice', myCurrentRoom);
        document.getElementById('btn-end-turn').onclick = () => {
            document.getElementById('btn-end-turn').style.display = 'none';
            socket.emit('endTurn', myCurrentRoom);
        };

        socket.on('diceRolled', (d) => { document.getElementById('dice-result').textContent = `üé≤ ${d.d1} - ${d.d2}`; });
        socket.on('askBuyProperty', (data) => {
            document.getElementById('modal-desc').textContent = `B·∫°n ƒëang ·ªü ${data.name}. Gi√° mua l√† $${data.price}. B·∫°n c√≥ mu·ªën mua kh√¥ng?`;
            document.getElementById('buy-modal').style.display = 'flex';
        });
        socket.on('enableEndTurn', () => { document.getElementById('btn-end-turn').style.display = 'block'; });
        socket.on('notification', (msg) => { document.getElementById('status-msg').textContent = msg; });

        function answerBuy(choice) {
            document.getElementById('buy-modal').style.display = 'none';
            socket.emit('confirmBuy', { roomId: myCurrentRoom, confirm: choice });
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="stylesheet" href="style.css">
    <style>
        body { background-color: #f1f2f6; }
        .admin-container { max-width: 1400px; margin: 20px auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; }
        
        /* (CSS Form - Cũ) */
        .admin-forms-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        @media (max-width: 900px) { .admin-forms-container { grid-template-columns: 1fr; } }
        .admin-create-form {
            background: #fdfdfd;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 20px;
        }
        .admin-create-form h2 { margin-top: 0; }
        .form-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        .form-group label {
            width: 120px;
            font-weight: bold;
        }
        .form-group input, .form-group select, .form-group textarea {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: inherit;
        }
        .create-btn {
            padding: 10px 20px; background-color: #3498db; color: white;
            border: none; border-radius: 5px; cursor: pointer; font-size: 1rem;
        }
        .create-btn:hover { background-color: #2980b9; }
        .create-btn.bot-btn { background-color: #9b59b6; }
        .create-btn.bot-btn:hover { background-color: #8e44ad; }
        .create-btn.broadcast-btn { background-color: #e67e22; }
        .create-btn.broadcast-btn:hover { background-color: #d35400; }
        .create-btn:disabled { background-color: #bdc3c7; cursor: not-allowed; }

        /* (CSS Nút Bảo Trì - Cũ) */
        .maintenance-btn {
            background-color: #e74c3c; /* Màu đỏ */
        }
        .maintenance-btn.safe {
            background-color: #2ecc71; /* Màu xanh */
        }
        #maintenance-status {
            font-weight: bold;
            margin-left: 15px;
        }

        /* (CSS Bảng - Cũ) */
        #user-table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
        #user-table th, #user-table td {
            padding: 10px; border: 1px solid #ddd;
            text-align: left; vertical-align: middle;
            word-wrap: break-word;
        }
        #user-table th { background-color: #f9f9f9; }
        #user-table input[type="number"] {
            width: 70px; padding: 5px; border: 1px solid #ccc;
            border-radius: 5px; font-size: 1rem;
        }

        /* (CSS Nút Hành Động - Cũ) */
        .action-btn {
            padding: 5px 10px; font-size: 0.9rem; color: white;
            border: none; border-radius: 5px; cursor: pointer;
            margin-right: 5px; margin-bottom: 5px; width: 85px; 
            text-align: center;
        }
        .save-btn { background-color: #2ecc71; }
        .save-btn:hover { background-color: #27ae60; }
        .delete-btn { background-color: #e74c3c; }
        .delete-btn:hover { background-color: #c0392b; }
        .notify-btn { background-color: #f39c12; }
        .notify-btn:hover { background-color: #e67e22; }
        .suspend-btn { background-color: #7f8c8d; }
        .suspend-btn:hover { background-color: #34495e; }
        .suspend-btn.active { background-color: #c0392b; font-weight: bold; }
        .reset-pw-btn { background-color: #3498db; }
        .reset-pw-btn:hover { background-color: #2980b9; }
        .transfer-btn { background-color: #1abc9c; } 
        .transfer-btn:hover { background-color: #16a085; }

        .role-parent { color: #2980b9; font-weight: bold; }
        .role-child { color: #2c3e50; }
        .role-suspended { color: #c0392b; text-decoration: line-through; }

        #message-log {
            margin-top: 20px; font-weight: bold;
            color: #2ecc71; text-align: center; min-height: 1.2em;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <h1>Bảng Điều Khiển Admin</h1>
        <p>Quản lý dữ liệu người chơi. (Chỉ Admin mới thấy trang này)</p>

        <div class="admin-forms-container">
            <div class="admin-create-form">
                <h2>Tạo Tài Khoản Đơn</h2>
                <form id="create-user-form">
                    <div class="form-group">
                        <label for="new-username">Username:</label>
                        <input type="text" id="new-username" required minlength="3">
                    </div>
                    <div class="form-group">
                        <label for="new-password">Password:</label>
                        <input type="password" id="new-password" required minlength="3">
                    </div>
                    <div class="form-group">
                        <label for="new-role">Vai trò:</label>
                        <select id="new-role">
                            <option value="parent">Phụ Huynh</option>
                            <option value="child">Trẻ Em</option>
                        </select>
                    </div>
                    <div class="form-group" id="parent-code-group" style="display: none;">
                        <label for="new-parentCode">Mã Phụ Huynh:</label>
                        <input type="text" id="new-parentCode" placeholder="Bắt buộc nếu tạo tài khoản Trẻ Em">
                    </div>
                    <button type="submit" class="create-btn">Tạo Tài Khoản</button>
                </form>
            </div>
            <div class="admin-create-form">
                <h2>Tạo Bot (Parent + Child)</h2>
                <p>Tạo nhanh các cặp tài khoản Phụ huynh-Trẻ em ngẫu nhiên để thử nghiệm. (Mật khẩu: BotPassword123)</p>
                <form id="create-random-batch-form">
                    <div class="form-group">
                        <label for="random-count">Số lượng cặp:</label>
                        <input type="number" id="random-count" required min="1" max="100" value="10">
                    </div>
                    <button type="submit" id="create-random-btn" class="create-btn bot-btn">Chạy Tạo Bot</button>
                </form>
            </div>
        </div>

        <div class="admin-create-form" style="background: #fffbe6;">
            <h2>Công Cụ Chung</h2>
            <form id="broadcast-form">
                <div class="form-group">
                    <label for="broadcast-message">Gửi Toàn Server:</label>
                    <textarea id="broadcast-message" rows="3" placeholder="Gõ thông báo... (vd: Server sẽ bảo trì trong 5 phút!)"></textarea>
                </div>
                <button type="submit" id="broadcast-btn" class="create-btn broadcast-btn">Gửi Broadcast</button>
            </form>
            <hr style="margin: 20px 0;">
            <div class="form-group">
                <label>Chế Độ Bảo Trì:</label>
                <button type="button" id="maintenance-toggle-btn" class="create-btn maintenance-btn">Đang tải...</button>
                <span id="maintenance-status">Đang tải trạng thái...</span>
            </div>
        </div>
        
        <div id="message-log"></div>

        <table id="user-table">
            <thead>
                <tr>
                    <th style="width: 15%;">Username</th>
                    <th style="width: 8%;">Vai trò</th>
                    <th style="width: 7%;">Điểm</th>
                    <th style="width: 25%;">Cấp Độ (Cờ, Car, GH, OC, LN)</th>
                    <th style="width: 15%;">Thời Gian Chơi</th>
                    <th style="width: 30%;">Hành động</th>
                </tr>
            </thead>
            <tbody id="user-table-body">
                <tr><td colspan="6" style="text-align: center;">Đang tải danh sách người chơi...</td></tr>
            </tbody>
        </table>
        
    </div>

    <a href="index.html" class="back-button" style="display: block; width: 200px; margin: 20px auto; text-align: center;">Về Trang Chủ</a>

    <script>
        // (Tất cả biến DOM cũ)
        const userTableBody = document.getElementById('user-table-body');
        const messageLog = document.getElementById('message-log');
        const createUserForm = document.getElementById('create-user-form');
        const newRoleSelect = document.getElementById('new-role');
        const parentCodeGroup = document.getElementById('parent-code-group');
        const createRandomBatchForm = document.getElementById('create-random-batch-form');
        const createRandomBtn = document.getElementById('create-random-btn');
        const broadcastForm = document.getElementById('broadcast-form');
        const broadcastBtn = document.getElementById('broadcast-btn');
        
        // (Biến DOM mới)
        const maintenanceToggleBtn = document.getElementById('maintenance-toggle-btn');
        const maintenanceStatusText = document.getElementById('maintenance-status');

        // (Tính năng cũ - fetchUsers)
        async function fetchUsers() {
            try {
                const response = await fetch('/api/admin/all-users');
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        alert('Bạn không có quyền truy cập! Đang chuyển về trang đăng nhập.');
                        window.location.href = '/login.html';
                    }
                    throw new Error('Không thể tải danh sách.');
                }
                const users = await response.json();
                renderTable(users);
            } catch (error) {
                userTableBody.innerHTML = `<tr><td colspan="6" style="color: red;">Lỗi: ${error.message}</td></tr>`;
            }
        }

        // (Tính năng cũ - renderTable, đã nâng cấp)
        function renderTable(users) {
            userTableBody.innerHTML = '';
            users.sort((a, b) => (a.role > b.role) ? 1 : -1); 
            
            users.forEach(user => {
                if (user.role === 'admin' && user.username !== 'Admin') return; 

                const row = document.createElement('tr');
                row.id = `user-${user.username}`;
                
                const isChild = user.role === 'child';
                const isAdmin = user.role === 'admin';
                const isSuspended = user.isSuspended === 1;
                const disabled = (isChild || isAdmin) ? '' : 'disabled'; 
                const isNotDeletableAdmin = user.username === 'Admin';
                
                const suspendClass = isSuspended ? 'role-suspended' : '';
                const suspendBtnText = isSuspended ? 'Mở Khóa' : 'Khóa';
                const suspendBtnClass = isSuspended ? 'active' : '';

                row.innerHTML = `
                    <td><strong class="${suspendClass}">${user.username}</strong></td>
                    <td><span class="role-${user.role} ${suspendClass}">${user.role}</span></td>
                    <td><input type="number" id="score-${user.username}" value="${user.score}" ${disabled}></td>
                    <td>
                        <input type="number" id="chessLevel-${user.username}" value="${user.chessLevel || 1}" ${disabled} title="Cờ Vua" style="width:45px;">
                        <input type="number" id="caroLevel-${user.username}" value="${user.caroLevel || 1}" ${disabled} title="Caro" style="width:45px;">
                        <input type="number" id="memoryLevel-${user.username}" value="${user.memoryLevel || 1}" ${disabled} title="Ghép Hình" style="width:45px;">
                        <input type="number" id="crosswordLevel-${user.username}" value="${user.crosswordLevel || 1}" ${disabled} title="Ô Chữ" style="width:45px;">
                        <input type="number" id="speechLevel-${user.username}" value="${user.speechLevel || 1}" ${disabled} title="Luyện Nói" style="width:45px;">
                    </td>
                    <td>
                        <input type="number" id="playtimeLimitMinutes-${user.username}" value="${user.playtimeLimitMinutes || 0}" ${disabled} min="0" title="Giới hạn (phút)">
                        <span>${isChild ? (user.playtimeUsedToday || 0) : 'N/A'} (đã chơi)</span>
                    </td>
                    <td style="white-space: normal;">
                        <button class="action-btn save-btn" onclick="saveUser('${user.username}')" ${disabled}>Lưu</button>
                        <button class="action-btn notify-btn" style="background:#8e44ad" onclick="assignCustomQuest('${user.username}')">Giao NV</button>
                        <button class="action-btn delete-btn" onclick="deleteUser('${user.username}', '${user.role}')" ${isNotDeletableAdmin ? 'disabled' : ''}>Xóa</button>
                        ${isChild ? `<button class="action-btn notify-btn" onclick="sendNotification('${user.username}')">Gửi TB</button>` : ''}
                        
                        <button class="action-btn suspend-btn ${suspendBtnClass}" onclick="toggleSuspend('${user.username}')" ${isNotDeletableAdmin ? 'disabled' : ''}>${suspendBtnText}</button>
                        <button class="action-btn reset-pw-btn" onclick="resetPassword('${user.username}')" ${isNotDeletableAdmin ? 'disabled' : ''}>Reset PW</button>
                        
                        ${isChild ? `<button class="action-btn transfer-btn" onclick="transferParent('${user.username}')">Chuyển PH</button>` : ''}
                    </td>
                `;
                userTableBody.appendChild(row);
            });
        }

        // (Tính năng cũ - saveUser)
        async function saveUser(username) {
            const dataToSave = {
                username: username,
                score: document.getElementById(`score-${username}`).value,
                chessLevel: document.getElementById(`chessLevel-${username}`).value,
                caroLevel: document.getElementById(`caroLevel-${username}`).value,
                memoryLevel: document.getElementById(`memoryLevel-${username}`).value,
                crosswordLevel: document.getElementById(`crosswordLevel-${username}`).value,
                speechLevel: document.getElementById(`speechLevel-${username}`).value,
                playtimeLimitMinutes: document.getElementById(`playtimeLimitMinutes-${username}`).value
            };
            try {
                const response = await fetch('/api/admin/update-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSave)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                showMessage(`Đã cập nhật thành công cho ${username}!`);
            } catch (error) {
                showMessage(`Lỗi: ${error.message}`, true);
            }
        }
        
        // (Tính năng cũ - deleteUser)
        async function deleteUser(username, role) {
            if (username === 'Admin') return;
            const confirmMsg = role === 'parent' 
                ? `Bạn có chắc muốn XÓA phụ huynh '${username}'? Tất cả tài khoản con của họ cũng sẽ bị xóa vĩnh viễn!`
                : `Bạn có chắc muốn XÓA tài khoản '${username}'?`;
            if (!confirm(confirmMsg)) return;
            try {
                 const response = await fetch('/api/admin/delete-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, role })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                showMessage(`Đã xóa thành công ${username}!`);
                document.getElementById(`user-${username}`).remove();
            } catch (error) {
                showMessage(`Lỗi khi xóa: ${error.message}`, true);
            }
        }

        // (Tính năng cũ - sendNotification)
        async function sendNotification(username) {
            const message = prompt(`Nhập nội dung thông báo cho '${username}':`);
            if (!message || message.trim() === '') {
                return;
            }
            try {
                const response = await fetch('/api/admin/send-notification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: username, message: message })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                showMessage(`Đã gửi thông báo cho ${username}!`);
            } catch (error) {
                showMessage(`Lỗi: ${error.message}`, true);
            }
        }
        
        // (Tính năng cũ - Logic Form 1)
        newRoleSelect.addEventListener('change', (e) => {
            parentCodeGroup.style.display = e.target.value === 'child' ? 'flex' : 'none';
        });
        createUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-role').value;
            const parentCode = document.getElementById('new-parentCode').value;
            const data = { username, password, role };
            if (role === 'child') { data.parentCode = parentCode; }
            try {
                 const response = await fetch('/api/admin/create-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                showMessage(result.message);
                createUserForm.reset(); 
                parentCodeGroup.style.display = 'none';
                fetchUsers(); 
            } catch (error) {
                showMessage(`Lỗi khi tạo: ${error.message}`, true);
            }
        });

        // (Tính năng cũ - Logic Form 2)
        createRandomBatchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const count = document.getElementById('random-count').value;
            if (!count || count <= 0 || count > 100) {
                showMessage("Vui lòng nhập số lượng từ 1 đến 100.", true);
                return;
            }
            if (!confirm(`Bạn có chắc muốn tạo ${count} cặp tài khoản Bot (Parent + Child)?`)) {
                return;
            }
            createRandomBtn.disabled = true;
            createRandomBtn.textContent = 'Đang tạo...';
            
            try {
                const response = await fetch('/api/admin/create-random-batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ count: count })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                
                showMessage(result.message);
                fetchUsers(); 
            } catch (error) {
                showMessage(`Lỗi khi tạo bot: ${error.message}`, true);
            } finally {
                createRandomBtn.disabled = false;
                createRandomBtn.textContent = 'Chạy Tạo Bot';
            }
        });

        // (Tính năng cũ - Logic Form 3: Broadcast)
        broadcastForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = document.getElementById('broadcast-message').value;
            if (!message || message.trim() === '') {
                showMessage("Vui lòng nhập tin nhắn broadcast.", true);
                return;
            }
            if (!confirm(`Bạn có chắc muốn gửi thông báo:\n"${message}"\nĐẾN TẤT CẢ NGƯỜI DÙNG?`)) {
                return;
            }
            broadcastBtn.disabled = true;
            broadcastBtn.textContent = 'Đang gửi...';
            
            try {
                const response = await fetch('/api/admin/broadcast', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                
                showMessage(result.message);
                document.getElementById('broadcast-message').value = '';
            } catch (error) {
                showMessage(`Lỗi broadcast: ${error.message}`, true);
            } finally {
                broadcastBtn.disabled = false;
                broadcastBtn.textContent = 'Gửi Broadcast';
            }
        });
        
        // (Tính năng cũ - Logic Nút Khóa / Mở Khóa)
        async function toggleSuspend(username) {
            if (username === 'Admin') return;
            
            const btn = document.querySelector(`#user-${username} .suspend-btn`);
            const isSuspending = !btn.classList.contains('active');
            const confirmMsg = isSuspending
                ? `Bạn có chắc muốn KHÓA tài khoản '${username}'? Họ sẽ bị đá ra khỏi game ngay lập tức.`
                : `Bạn có chắc muốn MỞ KHÓA tài khoản '${username}'?`;
                
            if (!confirm(confirmMsg)) return;

            try {
                 const response = await fetch('/api/admin/toggle-suspend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                
                showMessage(result.message);
                fetchUsers(); // Tải lại bảng
                
            } catch (error) {
                showMessage(`Lỗi: ${error.message}`, true);
            }
        }
        
        // (Tính năng cũ - Logic Nút Reset Mật Khẩu)
        async function resetPassword(username) {
            if (username === 'Admin') return;
            if (!confirm(`Bạn có chắc muốn reset mật khẩu của '${username}' về "123456"?`)) {
                return;
            }
            
            try {
                 const response = await fetch('/api/admin/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                
                showMessage(result.message); 
                alert(result.message); 
                
            } catch (error) {
                showMessage(`Lỗi: ${error.message}`, true);
            }
        }

        // --- TÍNH NĂNG MỚI (Thêm 2 hàm JS) ---
        
        // 1. Logic cho Nút Chuyển Phụ Huynh
        async function transferParent(childUsername) {
            const newParentCode = prompt(`Nhập MÃ PHỤ HUYNH (Parent Code) mới cho tài khoản '${childUsername}':`);
            if (!newParentCode || newParentCode.trim() === '') {
                return;
            }

            if (!confirm(`Bạn có chắc muốn chuyển '${childUsername}' cho phụ huynh có mã '${newParentCode}'?`)) {
                return;
            }

            try {
                const response = await fetch('/api/admin/transfer-child', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ childUsername, newParentCode: newParentCode.trim() })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                
                showMessage(result.message);
                fetchUsers(); // Tải lại bảng để cập nhật
                
            } catch (error) {
                showMessage(`Lỗi: ${error.message}`, true);
            }
        }
        
        // 2. Logic cho Nút Bảo Trì
        async function checkMaintenanceStatus() {
            try {
                const response = await fetch('/api/admin/maintenance-status');
                const result = await response.json();
                updateMaintenanceButton(result.maintenanceMode);
            } catch (error) {
                maintenanceStatusText.textContent = "Lỗi tải trạng thái";
                maintenanceStatusText.style.color = '#e74c3c';
            }
        }

        function updateMaintenanceButton(isMaintenance) {
            if (isMaintenance) {
                maintenanceToggleBtn.textContent = 'TẮT Chế Độ Bảo Trì';
                maintenanceToggleBtn.classList.remove('safe');
                maintenanceToggleBtn.classList.add('maintenance-btn');
                maintenanceStatusText.textContent = 'ĐANG BẬT';
                maintenanceStatusText.style.color = '#e74c3c';
            } else {
                maintenanceToggleBtn.textContent = 'BẬT Chế Độ Bảo Trì';
                maintenanceToggleBtn.classList.remove('maintenance-btn');
                maintenanceToggleBtn.classList.add('safe');
                maintenanceStatusText.textContent = 'ĐANG TẮT';
                maintenanceStatusText.style.color = '#2ecc71';
            }
        }

        maintenanceToggleBtn.addEventListener('click', async () => {
            const isCurrentlyOn = maintenanceStatusText.textContent === 'ĐANG BẬT';
            const action = isCurrentlyOn ? 'TẮT' : 'BẬT';
            
            if (!confirm(`Bạn có chắc muốn ${action} chế độ bảo trì?\n\n${action === 'BẬT' ? 'Hành động này sẽ ĐÁ tất cả người dùng (trừ Admin) ra khỏi server ngay lập tức.' : 'Người dùng sẽ có thể kết nối lại.'}`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/maintenance-toggle', { method: 'POST' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                
                updateMaintenanceButton(result.maintenanceMode);
                showMessage(`Đã ${action} chế độ bảo trì thành công.`);
                
            } catch (error) {
                showMessage(`Lỗi: ${error.message}`, true);
            }
        });

        // (Tính năng cũ - showMessage)
        function showMessage(message, isError = false) {
            messageLog.textContent = message;
            messageLog.style.color = isError ? '#e74c3c' : '#2ecc71';
            setTimeout(() => {
                messageLog.textContent = '';
                messageLog.style.color = '#2ecc71';
            }, 5000); 
        }

        // Chạy khi tải trang
        fetchUsers();
        checkMaintenanceStatus(); // (Mới)
       async function assignCustomQuest(username) {
    const desc = prompt(`Nhập nội dung nhiệm vụ cho ${username}: (VD: Đọc 5 bài Tiếng Anh)`);
    if (!desc) return;
    const target = prompt(`Nhập số lượng mục tiêu: (VD: 5)`, "1");
    const reward = prompt(`Nhập điểm thưởng:`, "100");

    try {
        const response = await fetch('/api/admin/assign-quest', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                username: username, 
                description: desc, 
                target: target, 
                reward: reward 
            })
        });
        const result = await response.json();
        alert(result.message);
    } catch (error) {
        alert("Lỗi khi giao nhiệm vụ!");
    }
}
    </script>
</body>
</html>
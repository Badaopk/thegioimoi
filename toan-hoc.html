<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>ƒê·∫•u To√°n Si√™u T·ªëc</title>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        body { background: #74b9ff; }
        .game-wrapper { max-width: 600px; margin: 40px auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 0 rgba(0,0,0,0.1); }
        
        .grade-btn { width: 100%; padding: 15px; margin: 5px 0; background: #0984e3; color: white; border: none; border-radius: 10px; font-size: 1.2rem; cursor: pointer; transition: 0.2s; }
        .grade-btn:hover { transform: scale(1.02); background: #74b9ff; }

        #game-board { display: none; text-align: center; }
        
        .score-board { display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 1.2rem; font-weight: bold; background: #eee; padding: 10px; border-radius: 10px; }
        .score-p1 { color: #2ecc71; }
        .score-p2 { color: #e74c3c; }

        .question-box { font-size: 2.5rem; margin: 30px 0; font-weight: bold; color: #2c3e50; min-height: 60px; }
        
        .answers-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .ans-btn { padding: 20px; font-size: 1.5rem; border: 3px solid #eee; background: white; border-radius: 10px; cursor: pointer; font-weight: bold; }
        .ans-btn:hover { background: #dff9fb; border-color: #0984e3; }
        .ans-btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .status-msg { margin-top: 20px; color: #636e72; font-style: italic; }
    </style>
</head>
<body>

    <h1 class="page-header header-challenge">‚ö° ƒê·∫•u To√°n Si√™u T·ªëc ‚ö°</h1>

    <div class="game-wrapper">
        
        <div id="lobby-screen">
            <h3>Ch·ªçn C·∫•p ƒê·ªô ƒê·ªÉ T√¨m ƒê·ªëi Th·ªß:</h3>
            <button class="grade-btn" onclick="findMatch(1)">L·ªõp 1 (C·ªông tr·ª´ c∆° b·∫£n)</button>
            <button class="grade-btn" onclick="findMatch(2)">L·ªõp 2 (Nh√¢n chia, ƒë·ªïi ƒë∆°n v·ªã)</button>
            <button class="grade-btn" onclick="findMatch(3)">L·ªõp 3 (T√≠nh nhanh, h√¨nh h·ªçc)</button>
            <button class="grade-btn" onclick="findMatch(4)">L·ªõp 4 (Ph√¢n s·ªë, s·ªë l·ªõn)</button>
            <button class="grade-btn" onclick="findMatch(5)">L·ªõp 5 (S·ªë th·∫≠p ph√¢n, %)</button>
            <div id="status-log" class="status-msg"></div>
            <a href="dau-truong-thu-thach.html" class="back-button" style="margin-top:20px; display:block;">Quay l·∫°i</a>
        </div>

        <div id="game-board">
            <div class="score-board">
                <span class="score-p1">B·∫°n: <span id="score-me">0</span></span>
                <span>V√≤ng: <span id="round-num">1</span>/10</span>
                <span class="score-p2">ƒê·ªëi th·ªß: <span id="score-op">0</span></span>
            </div>

            <div class="question-box" id="question-text">ƒêang t·∫£i...</div>

            <div class="answers-grid" id="options-area">
                </div>
            
            <div id="game-msg" class="status-msg"></div>
        </div>

    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentRoom = null;

        // 1. T√¨m tr·∫≠n
        function findMatch(grade) {
            document.getElementById('status-log').textContent = `ƒêang t√¨m ƒë·ªëi th·ªß l·ªõp ${grade}...`;
            // T·∫Øt n√∫t b·∫•m ƒë·ªÉ tr√°nh spam
            document.querySelectorAll('.grade-btn').forEach(b => b.disabled = true);
            
            socket.emit('findMathMatch', { grade: grade });
        }

        // 2. Khi t√¨m th·∫•y tr·∫≠n
        socket.on('matchFound', (data) => {
            currentRoom = data.room;
            document.getElementById('lobby-screen').style.display = 'none';
            document.getElementById('game-board').style.display = 'block';
            updateScores(data.players);
        });

        socket.on('statusUpdate', (data) => {
            document.getElementById('status-log').textContent = data.message;
        });

        // 3. Nh·∫≠n c√¢u h·ªèi m·ªõi
        socket.on('newQuestion', (data) => {
            document.getElementById('question-text').textContent = data.question;
            document.getElementById('round-num').textContent = data.round;
            document.getElementById('game-msg').textContent = "H√£y ch·ªçn ƒë√°p √°n ƒë√∫ng!";
            
            const optionsDiv = document.getElementById('options-area');
            optionsDiv.innerHTML = ''; // X√≥a n√∫t c≈©

            data.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'ans-btn';
                btn.textContent = opt;
                btn.onclick = () => submitAnswer(opt, btn);
                optionsDiv.appendChild(btn);
            });
        });

        // 4. G·ª≠i ƒë√°p √°n
        function submitAnswer(ans, btnElement) {
            // Disable t·∫•t c·∫£ n√∫t ƒë·ªÉ kh√¥ng ch·ªçn l·∫°i
            document.querySelectorAll('.ans-btn').forEach(b => b.disabled = true);
            btnElement.style.background = '#ffeaa7'; // Highlight l·ª±a ch·ªçn
            socket.emit('submitAnswer', { room: currentRoom, answer: ans });
            document.getElementById('game-msg').textContent = "ƒê√£ ch·ªçn! Ch·ªù ƒë·ªëi th·ªß...";
        }

        // 5. K·∫øt qu·∫£ v√≤ng ch∆°i
        socket.on('roundResult', (data) => {
            updateScores(data.players);
        });

        socket.on('answerResult', (data) => {
            // Hi·ªán ƒë√°p √°n ƒë√∫ng l√™n m√†n h√¨nh
            const btns = document.querySelectorAll('.ans-btn');
            btns.forEach(b => {
                if (b.textContent == data.correctAnswer) {
                    b.style.background = '#2ecc71'; // M√†u xanh l√°
                    b.style.color = 'white';
                }
            });
        });

        // 6. K·∫øt th√∫c game
        socket.on('gameOver', (data) => {
            updateScores(data.players);
            
            const myId = socket.id;
            const opponentId = Object.keys(data.players).find(id => id !== myId);
            
            let msg = "H√≤a nhau!";
            if (data.players[myId].score > data.players[opponentId].score) msg = "üéâ B·∫†N TH·∫ÆNG!";
            else if (data.players[myId].score < data.players[opponentId].score) msg = "üò≠ B·∫†N THUA!";

            setTimeout(() => {
                alert(`K·∫æT TH√öC!\n${msg}\nƒêi·ªÉm c·ªßa b·∫°n: ${data.players[myId].score}`);
                location.reload(); // T·∫£i l·∫°i trang ƒë·ªÉ v·ªÅ s·∫£nh
            }, 2000);
        });

        // 7. ƒê·ªëi th·ªß tho√°t
        socket.on('opponentLeft', () => {
            alert("ƒê·ªëi th·ªß ƒë√£ tho√°t tr·∫≠n! B·∫°n th·∫Øng.");
            location.reload();
        });

        function updateScores(players) {
            const myId = socket.id;
            const pIds = Object.keys(players);
            const opId = pIds.find(id => id !== myId);

            if (players[myId]) document.getElementById('score-me').textContent = players[myId].score;
            if (opId && players[opId]) document.getElementById('score-op').textContent = players[opId].score;
        }

    </script>
</body>
</html>
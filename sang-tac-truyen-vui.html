<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NhÃ  VÄƒn NhÃ­ TÃ i Ba - 100 Cáº¥p Äá»™</title>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        body { background: linear-gradient(135deg, #fff1eb 0%, #ace0f9 100%); font-family: 'Baloo 2', cursive; margin: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        
        .container { max-width: 900px; width: 95%; background: white; padding: 20px; margin: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }

        /* Chá»n Level */
        #level-screen { display: block; }
        .level-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; max-height: 60vh; overflow-y: auto; padding: 10px; }
        .lvl-btn { padding: 10px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; background: #eee; color: #7f8c8d; }
        .lvl-btn.unlocked { background: #6c5ce7; color: white; box-shadow: 0 4px 0 #574b90; }
        .lvl-btn.current { background: #fdcb6e; color: #2d3436; transform: scale(1.1); box-shadow: 0 4px 0 #e17055; border: 2px solid white; }
        .lvl-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Khu vá»±c viáº¿t truyá»‡n */
        #game-screen { display: none; text-align: left; }
        .theme-header { background: #dff9fb; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; border: 2px dashed #81ecec; }
        
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-weight: bold; color: #2d3436; margin-bottom: 5px; }
        .input-group input { width: 100%; padding: 12px; border: 2px solid #dfe6e9; border-radius: 10px; font-family: inherit; font-size: 1rem; box-sizing: border-box; transition: 0.3s; }
        .input-group input:focus { border-color: #6c5ce7; outline: none; background: #fdfdff; }

        /* Káº¿t quáº£ */
        #result-screen { display: none; }
        .story-book { 
            background: #fff; padding: 30px; border-radius: 5px; 
            box-shadow: 5px 0 15px rgba(0,0,0,0.1); 
            line-height: 1.8; font-size: 1.2rem; color: #2d3436; 
            border-left: 5px solid #6c5ce7; position: relative;
        }
        .score-badge {
            position: absolute; top: -20px; right: -20px; 
            background: #e17055; color: white; width: 80px; height: 80px; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-size: 1.5rem; font-weight: bold; transform: rotate(15deg); border: 4px solid white;
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
        }
        .highlight { color: #d63031; font-weight: bold; text-decoration: underline; }

        .btn { padding: 12px 30px; border-radius: 30px; border: none; font-weight: bold; font-size: 1.1rem; cursor: pointer; color: white; margin: 10px; box-shadow: 0 4px 0 rgba(0,0,0,0.2); font-family: inherit; }
        .btn-start { background: #00cec9; width: 100%; }
        .btn-home { background: #ff7675; }
        .btn-next { background: #6c5ce7; }
    </style>
</head>
<body>

    <h1 style="color: #2d3436; margin-top: 20px;">âœï¸ NHÃ€ VÄ‚N NHÃ - 100 Cáº¤P Äá»˜ âœï¸</h1>

    <div class="container">
        <div id="level-screen">
            <h3>Chá»n Chá»§ Äá» SÃ¡ng TÃ¡c:</h3>
            <div id="login-warning" style="display:none; color:red;">Báº¡n chÆ°a Ä‘Äƒng nháº­p. Äiá»ƒm sáº½ khÃ´ng Ä‘Æ°á»£c lÆ°u.</div>
            <div class="level-grid" id="level-list">Äang táº£i...</div>
            <button class="btn btn-home" onclick="window.location.href='index.html'">ğŸ  Vá» Trang Chá»§</button>
        </div>

        <div id="game-screen">
            <div class="theme-header">
                <h2 id="level-title" style="margin:0; color:#6c5ce7">Cáº¥p 1: Khu Rá»«ng</h2>
                <p id="level-desc" style="margin:5px 0; color:#636e72">HÃ£y Ä‘iá»n tá»« cÃ²n thiáº¿u Ä‘á»ƒ hoÃ n thÃ nh cÃ¢u chuyá»‡n nhÃ©!</p>
            </div>
            
            <form id="story-form">
                <div id="inputs-container"></div>
                <button type="submit" class="btn btn-start">âœ¨ HoÃ n ThÃ nh TÃ¡c Pháº©m âœ¨</button>
            </form>
            <button class="btn btn-home" style="width: 100px; margin-top: 20px;" onclick="backToMenu()">Quay láº¡i</button>
        </div>

        <div id="result-screen">
            <h2 style="color: #2ecc71;">TÃ¡c Pháº©m Cá»§a Báº¡n</h2>
            <div class="story-book">
                <div class="score-badge" id="score-display">100Ä‘</div>
                <div id="final-story-content"></div>
            </div>
            <p id="teacher-comment" style="font-style: italic; color: #636e72; margin-top: 15px;"></p>
            
            <button class="btn btn-home" onclick="backToMenu()">Chá»n Truyá»‡n KhÃ¡c</button>
            <button id="next-level-btn" class="btn btn-next" onclick="nextLevel()">Cáº¥p Tiáº¿p Theo â¡ï¸</button>
        </div>
    </div>

    <script>
        let unlockedLevel = 1;
        let currentLevel = 1;
        
        // --- KHO Dá»® LIá»†U Cá»T TRUYá»†N MáºªU (10 THEMES Láº¶P Láº I Vá»šI Äá»˜ KHÃ“ TÄ‚NG Dáº¦N) ---
        const storyTemplates = [
            // Theme 1: Khu Rá»«ng
            {
                title: "Cuá»™c PhiÃªu LÆ°u Trong Rá»«ng",
                inputs: [
                    {key: 'name', label: 'TÃªn cá»§a báº¡n'},
                    {key: 'adj1', label: 'Má»™t tÃ­nh tá»« (Vd: dÅ©ng cáº£m)'},
                    {key: 'animal', label: 'TÃªn má»™t con váº­t'},
                    {key: 'action', label: 'Má»™t hÃ nh Ä‘á»™ng (Vd: nháº£y mÃºa)'}
                ],
                template: "NgÃ y xá»­a ngÃ y xÆ°a, cÃ³ má»™t báº¡n nhá» tÃªn lÃ  {name}. Báº¡n áº¥y ráº¥t {adj1}. Má»™t hÃ´m, khi Ä‘i vÃ o rá»«ng, {name} gáº·p má»™t con {animal} khá»•ng lá»“ Ä‘ang {action}. Thay vÃ¬ sá»£ hÃ£i, {name} Ä‘Ã£ cÃ¹ng tham gia vÃ  há» trá»Ÿ thÃ nh báº¡n thÃ¢n."
            },
            // Theme 2: VÅ© Trá»¥
            {
                title: "Phi HÃ nh Gia NhÃ­",
                inputs: [
                    {key: 'planet', label: 'TÃªn má»™t hÃ nh tinh láº¡'},
                    {key: 'vehicle', label: 'PhÆ°Æ¡ng tiá»‡n di chuyá»ƒn'},
                    {key: 'alien', label: 'TÃªn ngÆ°á»i ngoÃ i hÃ nh tinh'},
                    {key: 'food', label: 'MÃ³n Äƒn yÃªu thÃ­ch'}
                ],
                template: "HÃ´m nay, tÃ´i lÃ¡i chiáº¿c {vehicle} siÃªu tá»‘c bay tháº³ng Ä‘áº¿n hÃ nh tinh {planet}. Táº¡i Ä‘Ã¢y, tÃ´i gáº·p {alien}, má»™t ngÆ°á»i báº¡n cÃ³ da mÃ u xanh lÃ¡. ChÃºng tÃ´i Ä‘Ã£ cÃ¹ng nhau Äƒn mÃ³n {food} vÃ  ngáº¯m nhÃ¬n cÃ¡c vÃ¬ sao lung linh."
            },
            // Theme 3: TrÆ°á»ng Há»c
            {
                title: "Lá»›p Há»c Vui Nhá»™n",
                inputs: [
                    {key: 'teacher', label: 'TÃªn tháº§y/cÃ´ giÃ¡o'},
                    {key: 'subject', label: 'MÃ´n há»c'},
                    {key: 'funny_thing', label: 'Má»™t Ä‘á»“ váº­t buá»“n cÆ°á»i'},
                    {key: 'emotion', label: 'Cáº£m xÃºc (Vd: vui sÆ°á»›ng)'}
                ],
                template: "HÃ´m nay trong giá» {subject}, tháº§y {teacher} Ä‘Ã£ mang Ä‘áº¿n lá»›p má»™t cÃ¡i {funny_thing} biáº¿t nÃ³i! Cáº£ lá»›p Ä‘á»u cáº£m tháº¥y vÃ´ cÃ¹ng {emotion}. ÄÃ³ lÃ  buá»•i há»c thÃº vá»‹ nháº¥t tráº§n Ä‘á»i."
            },
            // Theme 4: SiÃªu Anh HÃ¹ng
            {
                title: "SiÃªu Anh HÃ¹ng Báº¥t Äáº¯c DÄ©",
                inputs: [
                    {key: 'hero_name', label: 'TÃªn siÃªu anh hÃ¹ng cá»§a báº¡n'},
                    {key: 'power', label: 'SiÃªu nÄƒng lá»±c (Vd: bay, tÃ ng hÃ¬nh)'},
                    {key: 'villain', label: 'TÃªn káº» xáº¥u'},
                    {key: 'city', label: 'TÃªn thÃ nh phá»‘'}
                ],
                template: "Khi mÃ n Ä‘Ãªm buÃ´ng xuá»‘ng thÃ nh phá»‘ {city}, {hero_name} xuáº¥t hiá»‡n! Vá»›i kháº£ nÄƒng {power} siÃªu phÃ m, ngÆ°á»i hÃ¹ng cá»§a chÃºng ta Ä‘Ã£ Ä‘Ã¡nh báº¡i tÃªn {villain} Ä‘á»™c Ã¡c, mang láº¡i bÃ¬nh yÃªn cho má»i ngÆ°á»i."
            },
            // ... (Há»‡ thá»‘ng sáº½ tá»± Ä‘á»™ng biáº¿n táº¥u cÃ¡c máº«u nÃ y cho 100 cáº¥p Ä‘á»™)
        ];

        async function init() {
            try {
                const res = await fetch('/api/user/progress');
                if(res.status === 401) document.getElementById('login-warning').style.display = 'block';
                const data = await res.json();
                unlockedLevel = data.storyLevel || 1;
            } catch(e) {}
            renderLevels();
        }

        function renderLevels() {
            const list = document.getElementById('level-list');
            list.innerHTML = '';
            for(let i=1; i<=100; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = `lvl-btn ${i <= unlockedLevel ? 'unlocked' : ''} ${i === unlockedLevel ? 'current' : ''}`;
                btn.disabled = i > unlockedLevel;
                btn.onclick = () => startLevel(i);
                list.appendChild(btn);
            }
        }

        function startLevel(lvl) {
            currentLevel = lvl;
            // Chá»n máº«u truyá»‡n dá»±a trÃªn level (láº·p láº¡i nhÆ°ng yÃªu cáº§u khÃ³ hÆ¡n)
            const templateIndex = (lvl - 1) % storyTemplates.length;
            const baseTemplate = storyTemplates[templateIndex];
            
            // Render giao diá»‡n
            document.getElementById('level-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            document.getElementById('level-title').textContent = `Cáº¥p ${lvl}: ${baseTemplate.title}`;
            
            const formContainer = document.getElementById('inputs-container');
            formContainer.innerHTML = '';
            
            baseTemplate.inputs.forEach(input => {
                const group = document.createElement('div');
                group.className = 'input-group';
                // Level cao yÃªu cáº§u viáº¿t dÃ i hÆ¡n
                const placeholder = lvl > 20 ? "Viáº¿t má»™t cÃ¢u mÃ´ táº£ chi tiáº¿t..." : "Nháº­p 1 tá»« ngáº¯n...";
                group.innerHTML = `
                    <label>${input.label}:</label>
                    <input type="text" id="${input.key}" placeholder="${placeholder}" required>
                `;
                formContainer.appendChild(group);
            });

            // LÆ°u template hiá»‡n táº¡i Ä‘á»ƒ xá»­ lÃ½
            document.getElementById('story-form').onsubmit = (e) => {
                e.preventDefault();
                processStory(baseTemplate);
            };
        }

        function processStory(templateObj) {
            let finalStory = templateObj.template;
            let totalWords = 0;
            let inputsData = {};

            // Thay tháº¿ tá»« vÃ o truyá»‡n & Cháº¥m Ä‘iá»ƒm
            templateObj.inputs.forEach(input => {
                const val = document.getElementById(input.key).value.trim();
                inputsData[input.key] = val;
                // Äáº¿m sá»‘ tá»«
                totalWords += val.split(' ').length;
                // Thay tháº¿ vÃ o text (thÃªm class highlight)
                finalStory = finalStory.replace(`{${input.key}}`, `<span class="highlight">${val}</span>`);
            });

            // --- Há»† THá»NG CHáº¤M ÄIá»‚M THÃ”NG MINH ---
            let score = 0;
            let comment = "";

            // 1. Äiá»ƒm cÆ¡ báº£n hoÃ n thÃ nh: 50Ä‘
            score += 50;

            // 2. Äiá»ƒm Ä‘á»™ dÃ i (Khuyáº¿n khÃ­ch viáº¿t dÃ i á»Ÿ level cao)
            if (currentLevel < 10) {
                score += 50; // Level tháº¥p chá»‰ cáº§n Ä‘iá»n lÃ  max Ä‘iá»ƒm
                comment = "BÃ© lÃ m tá»‘t láº¯m! CÃ¢u chuyá»‡n ráº¥t ngá»™ nghÄ©nh.";
            } else {
                // Level cao cáº§n viáº¿t nhiá»u tá»« hÆ¡n
                if (totalWords >= templateObj.inputs.length * 2) score += 30;
                else score += 10;
                
                // Äiá»ƒm sÃ¡ng táº¡o (Kiá»ƒm tra láº·p tá»« Ä‘Æ¡n giáº£n)
                const values = Object.values(inputsData);
                const uniqueValues = new Set(values);
                if (uniqueValues.size === values.length) {
                    score += 20; // KhÃ´ng láº·p tá»«
                    comment = "Vá»‘n tá»« cá»§a bÃ© ráº¥t phong phÃº! Tuyá»‡t vá»i!";
                } else {
                    comment = "CÃ¢u chuyá»‡n hay, nhÆ°ng bÃ© hÃ£y thá»­ dÃ¹ng nhiá»u tá»« khÃ¡c nhau hÆ¡n nhÃ©!";
                }
            }

            // Hiá»ƒn thá»‹ káº¿t quáº£
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'block';
            document.getElementById('final-story-content').innerHTML = finalStory;
            document.getElementById('score-display').textContent = score + "Ä‘";
            document.getElementById('teacher-comment').textContent = "Nháº­n xÃ©t: " + comment;

            // NÃºt Next Level
            const nextBtn = document.getElementById('next-level-btn');
            if (score >= 50) {
                nextBtn.style.display = 'inline-block';
                saveProgress(score);
            } else {
                nextBtn.style.display = 'none';
            }
        }

        async function saveProgress(score) {
            if (currentLevel === unlockedLevel && unlockedLevel < 100) {
                unlockedLevel++;
            }
            
            try {
                const res = await fetch('/api/game/story-win', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ level: currentLevel, score: score })
                });
                const d = await res.json();
                if(d.newLevel) unlockedLevel = d.newLevel;
            } catch(e) { console.error(e); }
        }

        function nextLevel() {
            if (currentLevel < 100) startLevel(currentLevel + 1);
        }

        function backToMenu() {
            document.getElementById('result-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('level-screen').style.display = 'block';
            renderLevels();
        }

        init();
    </script>
</body>
</html>
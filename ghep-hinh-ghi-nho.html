<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gh√©p H√¨nh Ghi Nh·ªõ - Th·ª≠ Th√°ch 60 C·∫•p ƒê·ªô</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="stylesheet" href="style.css">
    <style>
        .memory-game-container { max-width: 900px; margin: 20px auto; background-color: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .level-selection { margin-bottom: 20px; }
        .level-btn {
            padding: 10px 15px; font-size: 1rem; margin: 5px; cursor: pointer; border: 2px solid #ccc;
            background-color: #f1f1f1; border-radius: 8px; font-family: 'Baloo 2', cursive;
        }
        .level-btn.unlocked { border-color: #2ecc71; background-color: #e8f8ef; }
        .level-btn.unlocked:hover { background-color: #d1f0e0; }
        .level-btn:disabled { background-color: #e9e9e9; color: #aaa; cursor: not-allowed; border-color: #ddd; }
        
        #game-area { display: none; }
        .memory-grid {
            display: grid;
            gap: 10px;
            perspective: 1000px;
            margin: 0 auto;
            width: fit-content;
        }
        .memory-card {
            width: 100px; height: 100px; position: relative;
            transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer;
        }
        .memory-card.flip { transform: rotateY(180deg); }
        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; border-radius: 10px;
            display: flex; justify-content: center; align-items: center; font-size: 3.5rem;
        }
        .card-front { background: #ffc107; color: white; }
        .card-back { background: #ffffff; border: 3px solid #ffc107; transform: rotateY(180deg); }
        
        .game-info {
            display: flex; justify-content: space-around; align-items: center;
            font-size: 1.5rem; font-weight: bold; margin-bottom: 20px;
            background: #f9f9f9; padding: 15px; border-radius: 10px;
        }
        #timer { color: #e74c3c; }
        
        @media (max-width: 600px) {
            .memory-card { width: 70px; height: 70px; }
            .card-face { font-size: 2.5rem; }
            .game-info { flex-direction: column; gap: 10px; }
        }
    </style>
</head>
<body class="creative-city-bg">
    <h1 class="page-header header-creative">üß† Gh√©p H√¨nh Ghi Nh·ªõ üß†</h1>
    
    <div class="memory-game-container">
        <div id="level-selection-area">
            <h2>Ch·ªçn C·∫•p ƒê·ªô</h2>
            <div id="level-buttons">
                <p>ƒêang t·∫£i c·∫•p ƒë·ªô...</p>
            </div>
            <div id="login-warning" style="display: none; color: red; font-weight: bold; margin-top: 15px; text-align: center;">
                B·∫°n ph·∫£i <a href="/login.html">ƒêƒÉng Nh·∫≠p</a> ƒë·ªÉ ch∆°i v√† l∆∞u c·∫•p ƒë·ªô.
            </div>
        </div>

        <div id="game-area">
            <div class="game-info">
                <div id="current-level-display">C·∫•p ƒë·ªô: 1</div>
                <div id="moves-counter">S·ªë l·∫ßn l·∫≠t: 0</div>
                <div id="timer">Th·ªùi gian: 00:00</div>
            </div>
            <div class="memory-grid" id="memory-grid"></div>
            <button id="back-to-levels-btn" class="back-button" style="margin-top: 20px;">Quay l·∫°i ch·ªçn C·∫•p ƒë·ªô</button>
        </div>
    </div>

    <a href="thanh-pho-sang-tao.html" class="back-button">V·ªÅ Th√†nh Ph·ªë S√°ng T·∫°o</a>

    <script>
        const levelSelectionArea = document.getElementById('level-selection-area');
        const levelButtonsContainer = document.getElementById('level-buttons');
        const gameArea = document.getElementById('game-area');
        const grid = document.getElementById('memory-grid');
        const movesCounterEl = document.getElementById('moves-counter');
        const timerEl = document.getElementById('timer');
        const levelDisplayEl = document.getElementById('current-level-display');
        const backToLevelsBtn = document.getElementById('back-to-levels-btn');
        const loginWarning = document.getElementById('login-warning');

        const allEmojis = ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üêî', 'üêß', 'üê¶', 'üê§', 'ü¶Ü', 'ü¶Ö', 'ü¶â', 'ü¶á', 'üê∫', 'üêó', 'üê¥', 'ü¶Ñ', 'üêù', 'üêõ', 'ü¶ã', 'üêå', 'üêû', 'üêú', 'ü¶ü', 'ü¶ó', 'üï∑Ô∏è'];

        // C·∫•u h√¨nh 60 c·∫•p ƒë·ªô
        const levels = Array.from({ length: 60 }, (_, i) => {
            const level = i + 1;
            const pairs = Math.min(allEmojis.length, 4 + Math.floor(level / 2) * 2);
            const columns = pairs <= 8 ? 4 : (pairs <= 18 ? 6 : 8);
            const timeLimit = Math.max(30, Math.floor(pairs * 8 - level * 1));
            return { level, pairs, columns, timeLimit };
        });

        let flippedCards = [], matchedPairs = 0, moves = 0, currentLevel = 1, timeLeft = 0, unlockedLevel = 1;
        let lockBoard = false, timerInterval;

        // --- THAY ƒê·ªîI: G·ª° b·ªè addScore() kh√¥ng an to√†n ---
        // async function addScore(points, activity) { ... } // <-- ƒê√É X√ìA

        // --- THAY ƒê·ªîI: Th√™m h√†m b√°o c√°o an to√†n ---
        async function reportGameWin(level, time) {
            try {
                // G·ªçi API an to√†n ƒë√£ c√≥ trong server.js
                const response = await fetch('/api/game/memory-win', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ level, time }) 
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('L·ªói b√°o c√°o chi·∫øn th·∫Øng:', errorData.message);
                }
            } catch (error) {
                console.error('L·ªói khi g·ª≠i b√°o c√°o chi·∫øn th·∫Øng:', error);
            }
        }
        
        // --- THAY ƒê·ªîI: Th√™m h√†m l·∫•y c·∫•p ƒë·ªô t·ª´ server ---
        async function fetchProgress() {
            try {
                const response = await fetch('/api/user/progress');
                if (!response.ok) {
                    if(response.status === 401) {
                        loginWarning.style.display = 'block';
                    }
                    return; 
                }
                const progress = await response.json();
                unlockedLevel = progress.memoryLevel || 1;
                loginWarning.style.display = 'none';
                createLevelButtons(); 
            } catch (error) {
                console.error('L·ªói khi t·∫£i ti·∫øn ƒë·ªô:', error);
                levelButtonsContainer.innerHTML = '<p style="color: red;">L·ªói khi t·∫£i ti·∫øn ƒë·ªô.</p>';
            }
        }

        function createLevelButtons() {
            levelButtonsContainer.innerHTML = '';
            levels.forEach(levelConfig => {
                const button = document.createElement('button');
                button.textContent = `C·∫•p ${levelConfig.level}`;
                button.className = 'level-btn';
                button.dataset.level = levelConfig.level;
                button.disabled = levelConfig.level > unlockedLevel;
                if (!button.disabled) button.classList.add('unlocked');
                button.onclick = () => startGame(levelConfig.level);
                levelButtonsContainer.appendChild(button);
            });
        }

        function startGame(level) {
            currentLevel = level;
            const config = levels[level - 1];
            levelSelectionArea.style.display = 'none';
            gameArea.style.display = 'block';
            levelDisplayEl.textContent = `C·∫•p ƒë·ªô: ${currentLevel}`;
            
            let emojisForLevel = allEmojis.slice(0, config.pairs);
            let cards = [...emojisForLevel, ...emojisForLevel].sort(() => Math.random() - 0.5);
            
            grid.innerHTML = '';
            grid.style.gridTemplateColumns = `repeat(${config.columns}, 1fr)`;
            matchedPairs = 0;
            moves = 0;
            movesCounterEl.textContent = `S·ªë l·∫ßn l·∫≠t: ${moves}`;
            lockBoard = false;

            cards.forEach(emoji => {
                const card = document.createElement('div');
                card.className = 'memory-card';
                card.dataset.emoji = emoji;
                card.innerHTML = `<div class="card-face card-front">?</div><div class="card-face card-back">${emoji}</div>`;
                card.onclick = flipCard;
                grid.appendChild(card);
            });

            timeLeft = config.timeLimit;
            startTimer();
        }

        function startTimer() {
            clearInterval(timerInterval);
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endGame(false);
                }
            }, 1000);
        }

        function updateTimerDisplay() {
             const minutes = Math.floor(timeLeft / 60).toString().padStart(2, '0');
             const seconds = (timeLeft % 60).toString().padStart(2, '0');
             timerEl.textContent = `Th·ªùi gian: ${minutes}:${seconds}`;
        }

        function flipCard() {
            if (lockBoard || this.classList.contains('flip') || flippedCards.length >= 2) return;
            this.classList.add('flip');
            flippedCards.push(this);
            if (flippedCards.length === 2) {
                moves++;
                movesCounterEl.textContent = `S·ªë l·∫ßn l·∫≠t: ${moves}`;
                lockBoard = true;
                setTimeout(checkForMatch, 700);
            }
        }

        function checkForMatch() {
            const [card1, card2] = flippedCards;
            if (card1.dataset.emoji === card2.dataset.emoji) {
                card1.onclick = null;
                card2.onclick = null;
                matchedPairs++;
                if (matchedPairs === levels[currentLevel - 1].pairs) {
                    clearInterval(timerInterval);
                    setTimeout(() => endGame(true), 500);
                }
            } else {
                card1.classList.remove('flip');
                card2.classList.remove('flip');
            }
            flippedCards = [];
            lockBoard = false;
        }
        
        function endGame(isWin) {
            if (isWin) {
                // --- THAY ƒê·ªîI: B√°o c√°o an to√†n ---
                // const points = currentLevel * 5 + Math.max(0, timeLeft); // <-- ƒê√É X√ìA
                // addScore(points, `Ho√†n th√†nh Gh√©p H√¨nh c·∫•p ${currentLevel}`); // <-- ƒê√É X√ìA
                reportGameWin(currentLevel, timeLeft);

                alert(`üéâ Ch√∫c m·ª´ng! B·∫°n ƒë√£ ho√†n th√†nh c·∫•p ƒë·ªô ${currentLevel}!`);
                
                if (currentLevel === unlockedLevel && unlockedLevel < 60) {
                    unlockedLevel++; // TƒÉng ·ªü client ƒë·ªÉ m·ªü kh√≥a n√∫t ngay
                }
                showLevelSelection();
            } else {
                alert(`üò≠ H·∫øt gi·ªù r·ªìi! H√£y th·ª≠ l·∫°i nh√©!`);
                showLevelSelection();
            }
        }
        
        function showLevelSelection() {
            gameArea.style.display = 'none';
            levelSelectionArea.style.display = 'block';
            createLevelButtons();
        }

        backToLevelsBtn.addEventListener('click', () => {
             clearInterval(timerInterval);
             showLevelSelection();
        });

        // --- THAY ƒê·ªîI: T·∫£i c·∫•p ƒë·ªô t·ª´ server khi b·∫Øt ƒë·∫ßu ---
        createLevelButtons(); // V·∫Ω n√∫t C·∫•p 1 ngay
        fetchProgress(); // H·ªèi server xem c√≥ c·∫•p cao h∆°n kh√¥ng
    </script>
<script src="/socket.io/socket.io.js"></script>
    <script src="global-client.js"></script>
</body>
</html>
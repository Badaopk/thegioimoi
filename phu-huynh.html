<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£ng ƒêi·ªÅu Khi·ªÉn C·ªßa Ph·ª• Huynh</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="stylesheet" href="style.css">
    <style>
        .dashboard-container { max-width: 800px; margin: 40px auto; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: left; }
        #parent-code-wrapper { background: #eee; padding: 15px; border-radius: 8px; }
        #parent-code { font-weight: bold; font-size: 1.2rem; color: #e74c3c; user-select: all; }
        .child-record { background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #eee; }
        .child-record h3 { margin-top: 0; color: #3498db; }
        .history-list { list-style-type: none; padding-left: 0; }
        .history-list li { margin-bottom: 10px; color: #555; border-left: 3px solid #1abc9c; padding-left: 15px; }
        .history-list li .time { font-size: 0.9em; color: #888; display: block; }
    </style>
</head>
<body class="my-home-bg">
    <h1 class="page-header header-home">üë§ B·∫£ng ƒêi·ªÅu Khi·ªÉn C·ªßa Ph·ª• Huynh</h1>
    <div class="dashboard-container" id="dashboard-content">
        <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
    </div>
    <a href="index.html" class="back-button">V·ªÅ Trang Ch·ªß</a>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const dashboardContent = document.getElementById('dashboard-content');
            try {
                const res = await fetch('/api/parent/dashboard');

                // N·∫øu kh√¥ng ƒë∆∞·ª£c x√°c th·ª±c, chuy·ªÉn v·ªÅ trang ƒëƒÉng nh·∫≠p
                if (res.status === 401 || res.status === 403) {
                    window.location.href = '/login.html';
                    return;
                }
                
                if (!res.ok) {
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu.');
                }

                const data = await res.json();
                
                let childrenHTML = '';
                if (data.children.length === 0) {
                    childrenHTML = '<p>Ch∆∞a c√≥ t√†i kho·∫£n n√†o c·ªßa con ƒë∆∞·ª£c li√™n k·∫øt. H√£y ƒë∆∞a m√£ k·∫øt n·ªëi cho b√© ƒë·ªÉ ƒëƒÉng k√Ω t√†i kho·∫£n.</p>';
                } else {
                    data.children.forEach(child => {
                        let historyHTML = '<ul class="history-list">';
                        if (child.history.length === 0) {
                            historyHTML += '<li>Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o ƒë∆∞·ª£c ghi l·∫°i.</li>';
                        } else {
                            child.history.forEach(log => {
                                const time = new Date(log.timestamp).toLocaleString('vi-VN');
                                historyHTML += `<li><strong>${log.activity}</strong><span class="time">${time}</span></li>`;
                            });
                        }
                        historyHTML += '</ul>';
                        childrenHTML += `<div class="child-record"><h3>T√†i kho·∫£n c·ªßa b√©: ${child.username}</h3>${historyHTML}</div>`;
                    });
                }

                dashboardContent.innerHTML = `
                    <div id="parent-code-wrapper">
                         <p>H√£y ƒë∆∞a m√£ n√†y cho con ƒë·ªÉ b√© c√≥ th·ªÉ li√™n k·∫øt t√†i kho·∫£n khi ƒëƒÉng k√Ω:</p>
                         <p id="parent-code">${data.parentCode}</p>
                    </div>
                    <h2 style="margin-top: 40px;">Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y c·ªßa c√°c con</h2>
                    <div id="children-container">${childrenHTML}</div>
                `;

            } catch (error) {
                dashboardContent.innerHTML = `<p style="color: red;">L·ªói: ${error.message}. Vui l√≤ng th·ª≠ ƒëƒÉng nh·∫≠p l·∫°i.</p>`;
            }
        });
    </script>
</body>
</html>
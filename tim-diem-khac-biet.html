<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th√°m T·ª≠ T√†i Ba</title>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        body { background: #2c3e50; font-family: 'Baloo 2', cursive; color: white; text-align: center; margin: 0; }
        
        .header { padding: 10px; background: rgba(0,0,0,0.2); margin-bottom: 20px; }
        .info-bar { display: flex; justify-content: center; gap: 20px; font-size: 1.2rem; font-weight: bold; }
        
        .game-area { 
            display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; 
            max-width: 100%; overflow: hidden;
        }
        
        .canvas-box { 
            position: relative; border: 4px solid white; border-radius: 10px; 
            cursor: crosshair; background: white;
        }
        
        /* ƒêi·ªÉm ƒë√°nh d·∫•u */
        .marker { 
            position: absolute; width: 30px; height: 30px; 
            border: 3px solid #2ecc71; border-radius: 50%; 
            transform: translate(-50%, -50%); pointer-events: none; 
            box-shadow: 0 0 5px #2ecc71;
        }
        .error-marker { 
            position: absolute; width: 20px; height: 20px; 
            border: 2px solid #e74c3c; background: rgba(231,76,60,0.5); 
            border-radius: 50%; transform: translate(-50%, -50%); 
            animation: fadeOut 0.5s forwards; 
        }
        @keyframes fadeOut { to { opacity: 0; transform: translate(-50%, -50%) scale(1.5); } }

        .btn { padding: 10px 20px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; margin: 5px; }
    </style>
</head>
<body>

    <div class="header">
        <h1>üïµÔ∏è TH√ÅM T·ª¨ T√ÄI BA</h1>
        <div class="info-bar">
            <span style="color:#f1c40f">C·∫•p ƒë·ªô: <span id="lvl">1</span></span>
            <span style="color:#e74c3c">C√≤n l·∫°i: <span id="diff-count">3</span></span>
        </div>
    </div>

    <div class="game-area">
        <div class="canvas-box" id="box1"><canvas id="c1" width="400" height="300"></canvas></div>
        <div class="canvas-box" id="box2"><canvas id="c2" width="400" height="300"></canvas></div>
    </div>

    <div style="margin-top: 20px;">
        <button class="btn" style="background:#3498db; color:white" onclick="useHint()">üí° G·ª£i √ù (<span id="hints">3</span>)</button>
        <button class="btn" style="background:#e74c3c; color:white" onclick="window.location.href='index.html'">üö™ Tho√°t</button>
    </div>

    <script>
        let level = 1;
        let diffs = []; 
        let found = [];
        let hintCount = 3;
        
        const ctx1 = document.getElementById('c1').getContext('2d');
        const ctx2 = document.getElementById('c2').getContext('2d');

        // B·ªô s∆∞u t·∫≠p v·∫≠t th·ªÉ theo ch·ªß ƒë·ªÅ
        const themes = {
            farm:   { bg: '#87CEEB', items: ['üè°','üå≥','üêÆ','üê∑','üêî','üöú','üåû','‚òÅÔ∏è'] }, // C·∫•p 1-20
            ocean:  { bg: '#006994', items: ['üê†','üêü','üê°','üêô','ü¶Ä','ü¶û','üåø','ü´ß'] }, // C·∫•p 21-40
            space:  { bg: '#000000', items: ['üöÄ','üõ∏','üåç','‚≠ê','ü™ê','‚òÑÔ∏è','üëΩ','üëæ'] }, // C·∫•p 41-60
            desert: { bg: '#F4A460', items: ['üåµ','üê™','ü¶Ç','üêç','ü¶¥','‚òÄÔ∏è','üèúÔ∏è','‚õ∫'] }, // C·∫•p 61-80
            snow:   { bg: '#E0FFFF', items: ['‚õÑ','‚ùÑÔ∏è','üå≤','üêß','üè†','üß£','üèÇ','üßä'] }  // C·∫•p 81-100
        };

        async function init() {
            try {
                const r = await fetch('/api/user/progress');
                const d = await r.json();
                level = d.detectiveLevel || 1;
            } catch(e) {}
            startLevel();
        }

        function startLevel() {
            document.getElementById('lvl').textContent = level;
            diffs = []; found = [];
            // X√≥a c√°c marker c≈©
            document.querySelectorAll('.marker').forEach(e => e.remove());
            
            // X√°c ƒë·ªãnh ch·ªß ƒë·ªÅ
            let themeKey = 'farm';
            if(level > 20) themeKey = 'ocean';
            if(level > 40) themeKey = 'space';
            if(level > 60) themeKey = 'desert';
            if(level > 80) themeKey = 'snow';
            
            drawScene(themes[themeKey]);
        }

        function drawScene(theme) {
            // 1. V·∫Ω n·ªÅn
            [ctx1, ctx2].forEach(ctx => {
                ctx.fillStyle = theme.bg;
                ctx.fillRect(0, 0, 400, 300);
            });

            // 2. V·∫Ω v·∫≠t th·ªÉ
            const itemCount = 5 + Math.floor(level / 5); // TƒÉng ƒë·ªô kh√≥: nhi·ªÅu ƒë·ªì h∆°n
            
            for(let i=0; i<itemCount; i++) {
                const item = theme.items[Math.floor(Math.random() * theme.items.length)];
                const x = 30 + Math.random() * 340;
                const y = 50 + Math.random() * 200;
                const size = 30 + Math.random() * 20;

                // V·∫Ω h√¨nh g·ªëc b√™n tr√°i
                ctx1.font = `${size}px Arial`;
                ctx1.fillText(item, x, y);

                // Quy·∫øt ƒë·ªãnh xem c√≥ t·∫°o ƒëi·ªÉm kh√°c bi·ªát kh√¥ng (Max 5 ƒëi·ªÉm)
                let isDiff = diffs.length < 5 && Math.random() < 0.35;

                if(isDiff) {
                    const type = Math.random();
                    if(type < 0.5) {
                        // Lo·∫°i 1: B√™n ph·∫£i KH√îNG C√ì h√¨nh n√†y
                        diffs.push({x: x + size/2, y: y - size/2, r: size});
                    } else {
                        // Lo·∫°i 2: B√™n ph·∫£i c√≥ h√¨nh KH√ÅC
                        const diffItem = theme.items[(theme.items.indexOf(item) + 1) % theme.items.length];
                        ctx2.font = `${size}px Arial`;
                        ctx2.fillText(diffItem, x, y);
                        diffs.push({x: x + size/2, y: y - size/2, r: size});
                    }
                } else {
                    // V·∫Ω gi·ªëng h·ªát b√™n ph·∫£i
                    ctx2.font = `${size}px Arial`;
                    ctx2.fillText(item, x, y);
                }
            }

            // ƒê·∫£m b·∫£o c√≥ √≠t nh·∫•t 3 ƒëi·ªÉm kh√°c bi·ªát, n·∫øu √≠t qu√° th√¨ v·∫Ω l·∫°i
            if(diffs.length < 3) return startLevel();
            
            document.getElementById('diff-count').textContent = diffs.length;
        }

        // X·ª≠ l√Ω click v√†o h√¨nh B√äN PH·∫¢I (Box 2)
        document.getElementById('box2').addEventListener('click', (e) => {
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left; // T·ªça ƒë·ªô trong canvas
            const y = e.clientY - rect.top;

            // Chuy·ªÉn ƒë·ªïi t·ªça ƒë·ªô chu·ªôt sang t·ªça ƒë·ªô canvas th·ª±c t·∫ø (n·∫øu b·ªã co gi√£n CSS)
            const scaleX = 400 / rect.width;
            const scaleY = 300 / rect.height;
            const realX = x * scaleX;
            const realY = y * scaleY;

            let hit = false;
            diffs.forEach((d, i) => {
                if(!found.includes(i)) {
                    const dist = Math.sqrt((realX - d.x)**2 + (realY - d.y)**2);
                    if(dist < d.r) {
                        hit = true;
                        found.push(i);
                        markFound(d.x, d.y);
                        document.getElementById('diff-count').textContent = diffs.length - found.length;
                        
                        if(found.length === diffs.length) doWin();
                    }
                }
            });

            if(!hit) {
                showError(x, y); // Hi·ªÉn th·ªã l·ªói t·∫°i v·ªã tr√≠ click (t·ªça ƒë·ªô CSS)
            }
        });

        function markFound(x, y) {
            // Marker c·∫ßn hi·ªán ·ªü c·∫£ 2 b√™n
            ['box1', 'box2'].forEach(id => {
                const m = document.createElement('div');
                m.className = 'marker';
                // Chuy·ªÉn t·ªça ƒë·ªô Canvas -> T·ªça ƒë·ªô CSS % ƒë·ªÉ responsive
                m.style.left = (x / 400 * 100) + '%';
                m.style.top = (y / 300 * 100) + '%';
                document.getElementById(id).appendChild(m);
            });
        }

        function showError(x, y) {
            const m = document.createElement('div');
            m.className = 'error-marker';
            m.style.left = x + 'px';
            m.style.top = y + 'px';
            document.getElementById('box2').appendChild(m);
            setTimeout(() => m.remove(), 500);
        }

        function useHint() {
            if(hintCount <= 0) return alert("H·∫øt g·ª£i √Ω r·ªìi!");
            const rem = diffs.find((d, i) => !found.includes(i));
            if(rem) {
                hintCount--;
                document.getElementById('hints').textContent = hintCount;
                markFound(rem.x, rem.y); // Hi·ªán lu√¥n ƒëi·ªÉm ƒë√≥ (t√≠nh l√† t√¨m th·∫•y ho·∫∑c ch·ªâ g·ª£i √Ω t√πy b·∫°n)
                // ·ªû ƒë√¢y t√¥i cho hi·ªán marker v√†ng t·∫°m th·ªùi
                const h = document.createElement('div');
                h.className = 'marker';
                h.style.borderColor = 'yellow';
                h.style.left = (rem.x / 400 * 100) + '%';
                h.style.top = (rem.y / 300 * 100) + '%';
                document.getElementById('box2').appendChild(h);
            }
        }

        async function doWin() {
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            try {
                const res = await fetch('/api/game/detective-win', { method: 'POST' });
                const d = await res.json();
                alert(`üéâ ${d.message || "B·∫°n th·∫≠t t√†i ba!"}`);
                if(d.newLevel) level = d.newLevel; else level++;
                startLevel();
            } catch(e) {
                level++; startLevel();
            }
        }

        init();
    </script>
</body>
</html>